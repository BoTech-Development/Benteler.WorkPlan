@page "/auth/forget-password"
@using Benteler.WorkPlan.Web.Api
@using static Benteler.WorkPlan.Web.Components.MessageBoxDialog
@inject NavigationManager NavigationManager

<MudStack>
	<MudItem>
		<MudText Typo="Typo.h4" Class="pa-4">Forget Password.</MudText>
	</MudItem>
	<MudItem>
		<MudPaper Class="pa-4">
			<MudText>
                Please enter your email address. We will send you an email with instructions to reset your password.
			</MudText>
			<MudTextField T="string"
						  Label="Email"
						  Variant="Variant.Outlined"
						  Required="true"
						  FullWidth="true"
						  @bind-Value="Email" />
		</MudPaper>
	</MudItem>
	<MudItem>
		<MudStack Row="true">
			<MudButton Variant="Variant.Outlined"
					   Color="Color.Secondary"
					   FullWidth="true"
                       OnClick="OnCancelClicked">
				Cancel
			</MudButton>
			<LoadingButton FullWidth="true"
						   Text="Send Email."
						   LoadingText="Logging in..."
						   TaskToProcess="OnSendEmailClicked" />
		</MudStack>
	</MudItem>
</MudStack>

<MessageBoxDialog IsErrorDialogOpen="@IsErrorDialogOpen"
				  DialogViewType="@DialogKind"
				  DialogViewActions="@DialogActions"
				  Title="@DialogTitle"
				  Message="@DialogMessage"
				  OnStandardDialogButtonClicked="OnMessageBoxButtonClicked" />
@code 
{
	[Parameter]
	[SupplyParameterFromQuery(Name = "lastPage")]
	public string? LastPage { get; set; }

	private string Email { get; set; } = string.Empty;

	public string DialogTitle { get; set; } = "Reset Password Email Sent";
	public string DialogMessage { get; set; } = string.Empty;
    public DialogActions DialogActions { get; set; } = DialogActions.Ok;
    public DialogType DialogKind { get; set; } = DialogType.Success;
    


	public bool IsErrorDialogOpen { get; set; } = false;
	private void OnCancelClicked()
	{
		NavigationManager.NavigateTo((LastPage == null) ? "/" : LastPage, true);
	}
	private async Task OnSendEmailClicked(LoadingButton button)
	{
		if (Email != string.Empty)
		{
			try
			{
				await TryToSendResetPasswordEmail();	
                DialogMessage = "If the email address you provided is registered, you will receive an email with instructions to reset your password. \n You can now close this page.";
                DialogActions = DialogActions.Ok;
                DialogKind = DialogType.Success;
				IsErrorDialogOpen = true;
			}
			catch (Exception ex)
			{
				Console.WriteLine(ex);
				button.Processing = false;
                DialogKind = DialogType.Error;
                DialogTitle = "Error Sending Reset Password Email";
                DialogActions = DialogActions.Ok;
				DialogMessage = ex.ToString();
				IsErrorDialogOpen = true;
                this.StateHasChanged();
			}
			button.Processing = false;
		}
	}
	private async Task TryToSendResetPasswordEmail()
	{
		ApiClient? client = null;
		if ((client = await ApiClient.GetInstance()) != null)
		{
			await client.AuthenticationClient.ResetPassword(Email);
		}
	}
	private void OnMessageBoxButtonClicked(MessageBoxDialog dialog, DialogActionType actionType)
	{
		IsErrorDialogOpen = false;
		this.StateHasChanged();
    }
}
