@using Benteler.WorkPlan.Api.SharedModels.Authentication.Result
@using Benteler.WorkPlan.Web.Client.Api
@using Benteler.WorkPlan.Web.Client.Components
@using BitzArt.Blazor.Cookies
@page "/auth/login"
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject ICookieService CookieService

@if (validatingOldToken)
{
	<MudStack Row="true">
		<MudProgressCircular Size="Size.Small"
							 Indeterminate="true" />
		<MudText>Validating (refreshing) old token...</MudText>
	</MudStack>
}
else
{
	<MudStack>
		<MudItem>
			<MudText Typo="Typo.h4" Class="pa-4">Login</MudText>
		</MudItem>
		<MudItem>
			<MudPaper Class="pa-4">
				<MudTextField T="string"
				Label="Email"
				Variant="Variant.Outlined"
				Required="true"
				FullWidth="true" 
				@bind-Value="Email"/>
				<MudTextField T="string"
				Label="Password"
				Variant="Variant.Outlined"
				Required="true"
				FullWidth="true"
				@bind-Value="Password"/>
				<MudText Typo="Typo.caption" 
				Class="mt-2"
				hidden="@isTowFactorCodeBoxVisisble">
					Please check your Authenticator app.
				</MudText>
				<MudTextField T="string"
				Label="Code"
				Variant="Variant.Outlined"
				Required="true"
				FullWidth="true"
				hidden="@isTowFactorCodeBoxVisisble"
				@bind-Value="Code" />
			</MudPaper>
		</MudItem>
		<MudItem>
			<MudStack Row="true">
				<MudButton Variant="Variant.Outlined"
				Color="Color.Secondary"
				FullWidth="true"
				>
					Cancel
				</MudButton>
				<LoadingButton FullWidth="true"
				Text="Login"
				LoadingText="Logging in..."
				TaskToProcess="OnLoginClicked" />
			</MudStack>
		</MudItem>
	</MudStack>
}
<ErrorDialog ErrorMessage="@ErrorMessage" IsErrorDialogOpen="@IsErrorDialogOpen"/>
@code {

	[Parameter]
	[SupplyParameterFromQuery(Name = "lastPage")]
	public string? LastPage { get; set; }

	public string Password { get; set; }
	public string Email { get; set; }
	public string Code { get; set; }

	public bool isTowFactorCodeBoxVisisble = false;
	public string ErrorMessage { get; set; }
	public bool IsErrorDialogOpen { get; set; } = false;

	public bool validatingOldToken { get; set; } = true;

	/// <summary>
	/// When there is already a valid login token in the cookies, the user will be redirected to the last page.
	/// </summary>
	protected override void OnInitialized()
	{
		TryToValidateOldToken();
	}

	private async Task TryToValidateOldToken()
	{
		ApiClient? client = null;
		if ((client = await ApiClient.GetInstance()) != null)
		{
			Console.WriteLine("Trying to validate/refresh token.");
			LoginToken? token = await client.AuthenticationClient.GetLoginTokenFromCookies(CookieService);
			if (token != null)
			{
				Console.WriteLine("Loaded Token from cookies.");
				client.AuthenticationClient.SaveLoginTokenToHttpRequestHelper(token); // Set the token to the HttpRequestHelper for the request header
				await ValidateToken(token);
			}
		}
		Console.WriteLine($"State has changed!");
		validatingOldToken = false;
		this.StateHasChanged();
	}

	private async Task<bool> ValidateToken(LoginToken token)
	{
		ApiClient? client = null;
		if ((client = await ApiClient.GetInstance()) != null)
		{
			try
			{
				Console.WriteLine("Trying to refresh the old token...");
				LoginToken? newToken = await client.AuthenticationClient.RefreshToken(token);
				if (newToken != null)
				{

					Console.WriteLine("Success!\n Saving cookie...");
					await client.AuthenticationClient.SaveLoginTokenToCookies(CookieService, newToken); // Save the token.
					//SaveCookies(newToken); // Save the token in cookies.
					if(LastPage == null)
					{
						LastPage = "/";
					}
					Console.WriteLine($"Redirecting to: {LastPage}");
					NavigationManager.NavigateTo(LastPage, true);
					return true;
				}
			}
			catch (Exception ex)
			{
				ErrorMessage = ex.ToString();
				IsErrorDialogOpen = true;
				Console.WriteLine(ex.Message);
			}
		}

		return false;
	}
	public async Task OnLoginClicked(LoadingButton button)
	{
		ApiClient? client = null;
		if ((client = await ApiClient.GetInstance()) != null)
		{
			try
			{
				await TryToLogin(client);
			}
			catch (Exception ex)
			{
				button.Processing = false;
				if (ex is ArgumentException)
				{
					if (ex.Message.Contains("Two factor authentication is enabled. Please provide the 2fa code."))
						isTowFactorCodeBoxVisisble = true; // User need to provide the 2fa code.
				}

				ErrorMessage = ex.ToString();
				IsErrorDialogOpen = true;
				Console.WriteLine(ex.Message);
			}
		}
	}
	private async Task TryToLogin(ApiClient client)
	{
		Console.WriteLine($"Trying to login... \n with the following params: Email: {Email} Password: {Password} Code: {Code}");
		LoginToken? token = await client.AuthenticationClient.Login(Email, Password, Code, "");
		if (token != null)
		{
			Console.WriteLine($"The Token is {token.AccessToken}");
			// Save the token to runtime and cookies.
			await client.AuthenticationClient.SaveLoginTokenToCookies(CookieService, token); 
			client.AuthenticationClient.SaveLoginTokenToHttpRequestHelper(token); 														   
			// Force every user to setup 2fa if not done yet
			await ValidateTwoFactorStatus(client);
		}
	}
	private async Task ValidateTwoFactorStatus(ApiClient client)
	{
		Console.WriteLine("Checking if 2fa is enabled...");
		if (!await client.AuthenticationClient.IsTwoFactorEnabled(Email))
		{
			Console.WriteLine("Move to " + $"/auth/enable2fa?lastPage={LastPage}&email={Email}");
			NavigationManager.NavigateTo($"/auth/enable2fa?lastPage={LastPage}&email={Email}", forceLoad: true);
		}
		else
		{
			if (LastPage == null)
			{
				LastPage = "/";
			}
			Console.WriteLine("Move to " + LastPage);
			NavigationManager.NavigateTo(LastPage, forceLoad: true);
		}
	}
}